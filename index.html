<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controla</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:sans-serif;}
body{
background:var(--bg);
color:var(--text);
display:flex;
justify-content:center;
transition:.3s;
}
:root{
--bg:#0f0f17;
--card:#181825;
--text:white;
--accent:#6a5cff;
}
.light{
--bg:#f4f6fb;
--card:white;
--text:#111;
--accent:#4c2cff;
}
.app{
width:100%;
max-width:430px;
min-height:100vh;
padding-bottom:90px;
}
header{
padding:20px;
text-align:center;
font-size:22px;
font-weight:700;
}
.card{
background:var(--card);
margin:15px;
padding:18px;
border-radius:18px;
box-shadow:0 0 20px rgba(0,0,0,.2);
}
.big{font-size:32px;font-weight:600;}
.small{opacity:.6;font-size:13px;}
button{
background:var(--accent);
border:none;
color:white;
padding:12px;
border-radius:12px;
margin-top:10px;
width:100%;
cursor:pointer;
}
input,select{
width:100%;
padding:10px;
margin-top:8px;
border-radius:10px;
border:none;
background:#2a2a35;
color:white;
}
.light input,.light select{
background:#eee;
color:#111;
}
.progress{
height:8px;
background:#333;
border-radius:20px;
overflow:hidden;
margin-top:8px;
}
.fill{
height:100%;
background:var(--accent);
}
nav{
position:fixed;
bottom:0;
width:100%;
max-width:430px;
display:flex;
justify-content:space-around;
background:var(--card);
padding:12px 0;
}
nav button{
background:none;
color:var(--text);
font-size:11px;
}
.view{display:none;}
.active{display:block;}
.fab{
position:fixed;
bottom:80px;
right:20px;
width:60px;
height:60px;
border-radius:50%;
background:var(--accent);
display:flex;
justify-content:center;
align-items:center;
font-size:30px;
color:white;
cursor:pointer;
}
</style>
</head>
<body>

<div class="app">

<header>
CONTROLA
<button onclick="toggleMode()">Modo</button>
</header>

<div id="inicio" class="view active">

<div class="card">
<div class="small">Saldo Actual</div>
<div class="big" id="saldo">$0</div>
<input type="number" id="saldoInput" placeholder="Editar saldo inicial">
<button onclick="guardarSaldo()">Actualizar</button>
</div>

<div class="card">
<canvas id="pieChart"></canvas>
</div>

</div>

<div id="registrar" class="view">
<div class="card">
<select id="tipo">
<option value="Ingreso">Ingreso</option>
<option value="Gasto">Gasto</option>
</select>
<input type="number" id="cantidad" placeholder="Cantidad">
<input type="text" id="categoria" placeholder="Categoría">
<button onclick="addMovimiento()">Guardar</button>
</div>
</div>

<div id="metas" class="view">
<div class="card">
<input type="text" id="metaNombre" placeholder="Nombre meta">
<input type="number" id="metaMonto" placeholder="Monto">
<button onclick="addMeta()">Crear Meta</button>
</div>
<div class="card" id="metasLista"></div>
</div>

<div id="historial" class="view">
<div class="card">
<button onclick="exportPDF()">Exportar PDF</button>
<ul id="lista"></ul>
</div>
</div>

<div id="analisis" class="view">
<div class="card">
<canvas id="barChart"></canvas>
</div>
</div>

<div class="fab" onclick="mostrar('registrar')">+</div>

<nav>
<button onclick="mostrar('inicio')">Inicio</button>
<button onclick="mostrar('metas')">Metas</button>
<button onclick="mostrar('historial')">Historial</button>
<button onclick="mostrar('analisis')">Análisis</button>
</nav>

</div>

<script>

if("serviceWorker" in navigator){
navigator.serviceWorker.register("sw.js");
}

let saldoBase=parseFloat(localStorage.getItem("saldoBase"))||0;
let movimientos=JSON.parse(localStorage.getItem("movimientos"))||[];
let metas=JSON.parse(localStorage.getItem("metas"))||[];

let pieChart,barChart;

function toggleMode(){
document.body.classList.toggle("light");
}

function mostrar(id){
document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
document.getElementById(id).classList.add("active");
render();
}

function guardarSaldo(){
saldoBase=parseFloat(saldoInput.value)||0;
localStorage.setItem("saldoBase",saldoBase);
render();
}

function addMovimiento(){
movimientos.push({
tipo:tipo.value,
cantidad:parseFloat(cantidad.value),
categoria:categoria.value,
fecha:new Date().toLocaleDateString()
});
localStorage.setItem("movimientos",JSON.stringify(movimientos));
render();
}

function addMeta(){
metas.push({
nombre:metaNombre.value,
monto:parseFloat(metaMonto.value)
});
localStorage.setItem("metas",JSON.stringify(metas));
render();
}

function exportPDF(){
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.text("Historial Controla",20,20);
movimientos.forEach((m,i)=>{
doc.text(`${m.fecha} - ${m.tipo} - $${m.cantidad}`,20,30+(i*10));
});
doc.save("historial.pdf");
}

function render(){

let ingresos=0,gastos=0;

movimientos.forEach(m=>{
if(m.tipo==="Ingreso") ingresos+=m.cantidad;
else gastos+=m.cantidad;
});

let saldoTotal=saldoBase+ingresos-gastos;
saldo.innerText="$"+saldoTotal;

lista.innerHTML=movimientos.map(m=>
`<li>${m.fecha} - ${m.tipo} - $${m.cantidad}</li>`
).join("");

metasLista.innerHTML=metas.map(m=>{
let porcentaje=Math.min((saldoTotal/m.monto)*100,100);
return `<div>
<strong>${m.nombre}</strong>
<div class="progress"><div class="fill" style="width:${porcentaje}%"></div></div>
</div>`;
}).join("");

if(pieChart) pieChart.destroy();
if(barChart) barChart.destroy();

pieChart=new Chart(document.getElementById("pieChart"),{
type:"doughnut",
data:{
labels:["Ingresos","Gastos"],
datasets:[{data:[ingresos,gastos],backgroundColor:["#6a5cff","#ff4c6a"]}]
}
});

barChart=new Chart(document.getElementById("barChart"),{
type:"bar",
data:{
labels:["Ingresos","Gastos"],
datasets:[{data:[ingresos,gastos],backgroundColor:["#6a5cff","#ff4c6a"]}]
}
});
}

render();

</script>

</body>
</html>
